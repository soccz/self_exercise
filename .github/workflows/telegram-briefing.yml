name: Telegram Briefing (Daily)

on:
  schedule:
    # 06:00 UTC = 15:00 KST (Afternoon Briefing before typical workout time)
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  cron:
    runs-on: ubuntu-latest
    steps:
      - name: Call Pre-Market Briefing Endpoint
        env:
          # Accept either a base URL (recommended) or a full endpoint URL (legacy).
          CRON_BASE_URL: ${{ secrets.CRON_BASE_URL }}
          CRON_ENDPOINT: ${{ secrets.CRON_ENDPOINT }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${APP_SECRET:-}" ]; then
            echo "Missing APP_SECRET secret"
            exit 1
          fi

          CANONICAL_BASE_URL="https://self-exercise.vercel.app"
          BASE_URL="${CRON_BASE_URL:-${CRON_ENDPOINT:-$CANONICAL_BASE_URL}}"
          BASE_URL="$(printf '%s' "$BASE_URL" | tr -d '\r' | sed 's/^ *//; s/ *$//')"
          if [ -z "${BASE_URL:-}" ]; then
            echo "Missing CRON_BASE_URL or CRON_ENDPOINT secret"
            echo "Examples:"
            echo "- CRON_BASE_URL: https://self-exercise.vercel.app"
            echo "- CRON_ENDPOINT: https://self-exercise.vercel.app/api/cron/briefing"
            exit 1
          fi

          # Logic: If CRON_BASE_URL is set, use it.
          # If only CRON_ENDPOINT is set, try to extract base.
          
          TARGET_PATH="/api/cron/briefing"
          
          if [ -n "${CRON_BASE_URL:-}" ]; then
            BASE="$CRON_BASE_URL"
          elif [ -n "${CRON_ENDPOINT:-}" ]; then
            # Strip /api/... from the endpoint to get base
            BASE=$(echo "$CRON_ENDPOINT" | sed 's|/api/.*||')
          else
            BASE="$CANONICAL_BASE_URL"
          fi
          
          # Clean trailing slash
          BASE="${BASE%/}"
          URL="$BASE$TARGET_PATH"

          echo "POST $URL"
          HTTP_CODE="$(
            curl -sS -D /tmp/briefing_headers.txt -o /tmp/briefing_response.json -w "%{http_code}" \
              -X POST "$URL" -H "x-app-secret: $APP_SECRET"
          )"
          echo "--- headers ---"
          cat /tmp/briefing_headers.txt || true
          echo "--- body ---"
          cat /tmp/briefing_response.json || true
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "Request failed with HTTP $HTTP_CODE"
            exit 1
          fi
